// Generated by purs version 0.11.6
"use strict";
var Common = require("../Common");
var Control_Applicative = require("../Control.Applicative");
var Control_Apply = require("../Control.Apply");
var Control_Bind = require("../Control.Bind");
var Control_Monad_Aff = require("../Control.Monad.Aff");
var Control_Monad_Aff_Class = require("../Control.Monad.Aff.Class");
var Control_Monad_State_Class = require("../Control.Monad.State.Class");
var DOM = require("../DOM");
var Data_Argonaut_Core = require("../Data.Argonaut.Core");
var Data_Argonaut_Parser = require("../Data.Argonaut.Parser");
var Data_Either = require("../Data.Either");
var Data_Eq = require("../Data.Eq");
var Data_Foldable = require("../Data.Foldable");
var Data_Function = require("../Data.Function");
var Data_Functor = require("../Data.Functor");
var Data_Maybe = require("../Data.Maybe");
var Data_Monoid = require("../Data.Monoid");
var Data_Ord = require("../Data.Ord");
var Data_Ordering = require("../Data.Ordering");
var Data_Semigroup = require("../Data.Semigroup");
var Data_StrMap = require("../Data.StrMap");
var Data_Traversable = require("../Data.Traversable");
var Data_Tuple = require("../Data.Tuple");
var Data_Void = require("../Data.Void");
var GBFS = require("../GBFS");
var Halogen = require("../Halogen");
var Halogen_Component = require("../Halogen.Component");
var Halogen_HTML = require("../Halogen.HTML");
var Halogen_HTML_Core = require("../Halogen.HTML.Core");
var Halogen_HTML_Elements = require("../Halogen.HTML.Elements");
var Halogen_Query_HalogenM = require("../Halogen.Query.HalogenM");
var Network_HTTP_Affjax = require("../Network.HTTP.Affjax");
var Network_HTTP_Affjax_Response = require("../Network.HTTP.Affjax.Response");
var Prelude = require("../Prelude");
var StationTable = require("../StationTable");
var HOME = (function () {
    function HOME() {

    };
    HOME.value = new HOME();
    return HOME;
})();
var WORK = (function () {
    function WORK() {

    };
    WORK.value = new WORK();
    return WORK;
})();
var Refresh = (function () {
    function Refresh(value0) {
        this.value0 = value0;
    };
    Refresh.create = function (value0) {
        return new Refresh(value0);
    };
    return Refresh;
})();
var mergeHWData = function (is) {
    var idMap = Data_StrMap.unions(Data_Foldable.foldableArray)(Data_Functor.map(Data_Functor.functorArray)(function (s) {
        return Data_StrMap.singleton(s.station_id)(s);
    })(is.info));
    var findStatus = function (status) {
        var v = Data_StrMap.lookup(status.station_id)(idMap);
        if (v instanceof Data_Maybe.Nothing) {
            return Data_Monoid.mempty(Data_Monoid.monoidArray);
        };
        if (v instanceof Data_Maybe.Just) {
            return Control_Applicative.pure(Control_Applicative.applicativeArray)({
                info: v.value0, 
                status: status
            });
        };
        throw new Error("Failed pattern match at App line 99, column 25 - line 101, column 53: " + [ v.constructor.name ]);
    };
    return Data_Foldable.foldMap(Data_Foldable.foldableArray)(Data_Monoid.monoidArray)(findStatus)(is.status);
};
var eqButtonSlot = new Data_Eq.Eq(function (x) {
    return function (y) {
        if (x instanceof HOME && y instanceof HOME) {
            return true;
        };
        if (x instanceof WORK && y instanceof WORK) {
            return true;
        };
        return false;
    };
});
var ordButtonSlot = new Data_Ord.Ord(function () {
    return eqButtonSlot;
}, function (x) {
    return function (y) {
        if (x instanceof HOME && y instanceof HOME) {
            return Data_Ordering.EQ.value;
        };
        if (x instanceof HOME) {
            return Data_Ordering.LT.value;
        };
        if (y instanceof HOME) {
            return Data_Ordering.GT.value;
        };
        if (x instanceof WORK && y instanceof WORK) {
            return Data_Ordering.EQ.value;
        };
        throw new Error("Failed pattern match at App line 29, column 8 - line 29, column 42: " + [ x.constructor.name, y.constructor.name ]);
    };
});
var ui = (function () {
    var render = function (st) {
        if (st instanceof Data_Maybe.Nothing) {
            return Halogen_HTML_Core.text("Loading...");
        };
        if (st instanceof Data_Maybe.Just) {
            var v = Control_Apply.apply(Data_Either.applyEither)(Data_Functor.map(Data_Either.functorEither)(Data_Tuple.Tuple.create)(st.value0.stationStatuses))(st.value0.stationInfos);
            if (v instanceof Data_Either.Left) {
                return Halogen_HTML_Core.text("Error: " + v.value0);
            };
            if (v instanceof Data_Either.Right) {
                var hwData = mergeHWData({
                    info: v.value0.value1, 
                    status: v.value0.value0
                });
                return Halogen_HTML_Elements.div_([ Halogen_HTML.slot(HOME.value)(StationTable.stationTable)(StationTable.mkTableData({
                    place: Common.home, 
                    stations: hwData, 
                    initLimit: 8
                }))(Data_Void.absurd), Halogen_HTML.slot(WORK.value)(StationTable.stationTable)(StationTable.mkTableData({
                    place: Common.work, 
                    stations: hwData, 
                    initLimit: 6
                }))(Data_Void.absurd) ]);
            };
            throw new Error("Failed pattern match at App line 64, column 11 - line 70, column 27: " + [ v.constructor.name ]);
        };
        throw new Error("Failed pattern match at App line 61, column 7 - line 70, column 27: " + [ st.constructor.name ]);
    };
    var getParse = function (parser) {
        return function (url) {
            var parseResponse = function (s) {
                return Control_Bind.bind(Data_Either.bindEither)(Data_Argonaut_Parser.jsonParser(s))(function (v) {
                    return Data_Functor.map(Data_Either.functorEither)(function (v1) {
                        return v1["data'"];
                    })(parser(v));
                });
            };
            return Control_Bind.bind(Control_Monad_Aff.bindAff)(Network_HTTP_Affjax.get(Network_HTTP_Affjax_Response.responsableString)(url))(function (v) {
                return Control_Applicative.pure(Control_Monad_Aff.applicativeAff)(parseResponse(v.response));
            });
        };
    };
    var $$eval = function (v) {
        return Control_Bind.bind(Halogen_Query_HalogenM.bindHalogenM)(Control_Monad_Aff_Class.liftAff(Halogen_Query_HalogenM.monadAffHalogenM(Control_Monad_Aff_Class.monadAffAff))(getParse(GBFS.parseStationInfos)(Common.infoUrl)))(function (v1) {
            return Control_Bind.bind(Halogen_Query_HalogenM.bindHalogenM)(Control_Monad_Aff_Class.liftAff(Halogen_Query_HalogenM.monadAffHalogenM(Control_Monad_Aff_Class.monadAffAff))(getParse(GBFS.parseStationStatuses)(Common.statusUrl)))(function (v2) {
                return Control_Bind.discard(Control_Bind.discardUnit)(Halogen_Query_HalogenM.bindHalogenM)(Control_Monad_State_Class.put(Halogen_Query_HalogenM.monadStateHalogenM)(new Data_Maybe.Just({
                    stationStatuses: v2, 
                    stationInfos: v1
                })))(function () {
                    return Control_Applicative.pure(Halogen_Query_HalogenM.applicativeHalogenM)(v.value0);
                });
            });
        });
    };
    return Halogen_Component.parentComponent(ordButtonSlot)({
        initialState: Data_Function["const"](Data_Maybe.Nothing.value), 
        render: render, 
        "eval": $$eval, 
        receiver: Data_Function["const"](Data_Maybe.Nothing.value)
    });
})();
module.exports = {
    Refresh: Refresh, 
    ui: ui
};
