// Generated by purs version 0.11.6
"use strict";
var Common = require("../Common");
var Control_Applicative = require("../Control.Applicative");
var Control_Bind = require("../Control.Bind");
var Control_Comonad = require("../Control.Comonad");
var Control_Monad_Aff = require("../Control.Monad.Aff");
var Control_Monad_Aff_Class = require("../Control.Monad.Aff.Class");
var Control_Monad_Eff_Class = require("../Control.Monad.Eff.Class");
var Control_Monad_Eff_Now = require("../Control.Monad.Eff.Now");
var Control_Monad_State_Class = require("../Control.Monad.State.Class");
var DOM = require("../DOM");
var Data_Argonaut_Core = require("../Data.Argonaut.Core");
var Data_Argonaut_Parser = require("../Data.Argonaut.Parser");
var Data_DateTime_Locale = require("../Data.DateTime.Locale");
var Data_Either = require("../Data.Either");
var Data_Eq = require("../Data.Eq");
var Data_Foldable = require("../Data.Foldable");
var Data_Function = require("../Data.Function");
var Data_Functor = require("../Data.Functor");
var Data_Maybe = require("../Data.Maybe");
var Data_Monoid = require("../Data.Monoid");
var Data_Ord = require("../Data.Ord");
var Data_Ordering = require("../Data.Ordering");
var Data_Semigroup = require("../Data.Semigroup");
var Data_Show = require("../Data.Show");
var Data_StrMap = require("../Data.StrMap");
var Data_Time = require("../Data.Time");
var Data_Traversable = require("../Data.Traversable");
var Data_Void = require("../Data.Void");
var GBFS = require("../GBFS");
var Halogen = require("../Halogen");
var Halogen_Component = require("../Halogen.Component");
var Halogen_HTML = require("../Halogen.HTML");
var Halogen_HTML_Core = require("../Halogen.HTML.Core");
var Halogen_HTML_Elements = require("../Halogen.HTML.Elements");
var Halogen_HTML_Events = require("../Halogen.HTML.Events");
var Halogen_HTML_Properties = require("../Halogen.HTML.Properties");
var Halogen_Query = require("../Halogen.Query");
var Halogen_Query_HalogenM = require("../Halogen.Query.HalogenM");
var Network_HTTP_Affjax = require("../Network.HTTP.Affjax");
var Network_HTTP_Affjax_Response = require("../Network.HTTP.Affjax.Response");
var Prelude = require("../Prelude");
var StationTable = require("../StationTable");
var Loading = (function () {
    function Loading() {

    };
    Loading.value = new Loading();
    return Loading;
})();
var $$Error = (function () {
    function $$Error(value0) {
        this.value0 = value0;
    };
    $$Error.create = function (value0) {
        return new $$Error(value0);
    };
    return $$Error;
})();
var HWData = (function () {
    function HWData(value0, value1) {
        this.value0 = value0;
        this.value1 = value1;
    };
    HWData.create = function (value0) {
        return function (value1) {
            return new HWData(value0, value1);
        };
    };
    return HWData;
})();
var HOME = (function () {
    function HOME() {

    };
    HOME.value = new HOME();
    return HOME;
})();
var WORK = (function () {
    function WORK() {

    };
    WORK.value = new WORK();
    return WORK;
})();
var Refresh = (function () {
    function Refresh(value0) {
        this.value0 = value0;
    };
    Refresh.create = function (value0) {
        return new Refresh(value0);
    };
    return Refresh;
})();
var refreshButton = Halogen_HTML_Elements.button([ Halogen_HTML_Properties.title("refresh"), Halogen_HTML_Events.onClick(Halogen_HTML_Events.input_(Refresh.create)) ])([ Halogen_HTML_Core.text("refresh") ]);
var mergeHWData = function (is) {
    var idMap = Data_StrMap.unions(Data_Foldable.foldableArray)(Data_Functor.map(Data_Functor.functorArray)(function (s) {
        return Data_StrMap.singleton(s.station_id)(s);
    })(is.info));
    var findStatus = function (status) {
        var v = Data_StrMap.lookup(status.station_id)(idMap);
        if (v instanceof Data_Maybe.Nothing) {
            return Data_Monoid.mempty(Data_Monoid.monoidArray);
        };
        if (v instanceof Data_Maybe.Just) {
            return Control_Applicative.pure(Control_Applicative.applicativeArray)({
                info: v.value0, 
                status: status
            });
        };
        throw new Error("Failed pattern match at App line 116, column 25 - line 118, column 54: " + [ v.constructor.name ]);
    };
    return Data_Foldable.foldMap(Data_Foldable.foldableArray)(Data_Monoid.monoidArray)(findStatus)(is.status);
};
var mkHWData = function (v) {
    return function (v1) {
        if (v instanceof Data_Either.Right && v1 instanceof Data_Either.Right) {
            return Data_Maybe.Just.create(mergeHWData({
                info: v.value0, 
                status: v1.value0
            }));
        };
        return Data_Maybe.Nothing.value;
    };
};
var getParse = function (parser) {
    return function (url) {
        var parseResponse = function (s) {
            return Control_Bind.bind(Data_Either.bindEither)(Data_Argonaut_Parser.jsonParser(s))(function (v) {
                return Data_Functor.map(Data_Either.functorEither)(function (v1) {
                    return v1["data'"];
                })(parser(v));
            });
        };
        return Control_Bind.bind(Control_Monad_Aff.bindAff)(Network_HTTP_Affjax.get(Network_HTTP_Affjax_Response.responsableString)(url))(function (v) {
            return Control_Applicative.pure(Control_Monad_Aff.applicativeAff)(parseResponse(v.response));
        });
    };
};
var eqButtonSlot = new Data_Eq.Eq(function (x) {
    return function (y) {
        if (x instanceof HOME && y instanceof HOME) {
            return true;
        };
        if (x instanceof WORK && y instanceof WORK) {
            return true;
        };
        return false;
    };
});
var ordButtonSlot = new Data_Ord.Ord(function () {
    return eqButtonSlot;
}, function (x) {
    return function (y) {
        if (x instanceof HOME && y instanceof HOME) {
            return Data_Ordering.EQ.value;
        };
        if (x instanceof HOME) {
            return Data_Ordering.LT.value;
        };
        if (y instanceof HOME) {
            return Data_Ordering.GT.value;
        };
        if (x instanceof WORK && y instanceof WORK) {
            return Data_Ordering.EQ.value;
        };
        throw new Error("Failed pattern match at App line 32, column 8 - line 32, column 42: " + [ x.constructor.name, y.constructor.name ]);
    };
});
var ui = (function () {
    var render = function (st) {
        if (st instanceof Loading) {
            return Halogen_HTML_Core.text("Loading...");
        };
        if (st instanceof $$Error) {
            return Halogen_HTML_Elements.div_([ Halogen_HTML_Core.text("Error: " + st.value0), refreshButton ]);
        };
        if (st instanceof HWData) {
            return Halogen_HTML_Elements.div_([ refreshButton, Halogen_HTML_Core.text("Last updated: " + Data_Show.show(Data_Time.showTime)(st.value1)), Halogen_HTML.slot(HOME.value)(StationTable.stationTable)(StationTable.mkTableData({
                place: Common.home, 
                stations: st.value0, 
                initLimit: 7
            }))(Data_Void.absurd), Halogen_HTML.slot(WORK.value)(StationTable.stationTable)(StationTable.mkTableData({
                place: Common.work, 
                stations: st.value0, 
                initLimit: 6
            }))(Data_Void.absurd) ]);
        };
        throw new Error("Failed pattern match at App line 65, column 7 - line 73, column 20: " + [ st.constructor.name ]);
    };
    var $$eval = function (v) {
        return Control_Bind.bind(Halogen_Query_HalogenM.bindHalogenM)(Control_Monad_Aff_Class.liftAff(Halogen_Query_HalogenM.monadAffHalogenM(Control_Monad_Aff_Class.monadAffAff))(getParse(GBFS.parseStationInfos)(Common.infoUrl)))(function (v1) {
            return Control_Bind.bind(Halogen_Query_HalogenM.bindHalogenM)(Control_Monad_Aff_Class.liftAff(Halogen_Query_HalogenM.monadAffHalogenM(Control_Monad_Aff_Class.monadAffAff))(getParse(GBFS.parseStationStatuses)(Common.statusUrl)))(function (v2) {
                var v3 = mkHWData(v1)(v2);
                if (v3 instanceof Data_Maybe.Nothing) {
                    return Control_Applicative.pure(Halogen_Query_HalogenM.applicativeHalogenM)(v.value0);
                };
                if (v3 instanceof Data_Maybe.Just) {
                    return Control_Bind.bind(Halogen_Query_HalogenM.bindHalogenM)(Control_Monad_Eff_Class.liftEff(Halogen_Query_HalogenM.monadEffHalogenM(Control_Monad_Aff.monadEffAff))(Control_Monad_Eff_Now.nowTime))(function (v4) {
                        return Control_Bind.discard(Control_Bind.discardUnit)(Halogen_Query_HalogenM.bindHalogenM)(Control_Monad_State_Class.put(Halogen_Query_HalogenM.monadStateHalogenM)(new HWData(v3.value0, Control_Comonad.extract(Data_DateTime_Locale.comonadLocalValue)(v4))))(function () {
                            return Control_Bind.bind(Halogen_Query_HalogenM.bindHalogenM)(Halogen_Query.queryAll(ordButtonSlot)(Halogen_Query.action(StationTable.NewData.create(v3.value0))))(function (v5) {
                                return Control_Applicative.pure(Halogen_Query_HalogenM.applicativeHalogenM)(v.value0);
                            });
                        });
                    });
                };
                throw new Error("Failed pattern match at App line 80, column 7 - line 86, column 20: " + [ v3.constructor.name ]);
            });
        });
    };
    return Halogen_Component.parentComponent(ordButtonSlot)({
        initialState: Data_Function["const"](Loading.value), 
        render: render, 
        "eval": $$eval, 
        receiver: Data_Function["const"](Data_Maybe.Nothing.value)
    });
})();
module.exports = {
    Refresh: Refresh, 
    ui: ui
};
